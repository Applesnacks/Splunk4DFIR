name: Windows Transforms
priority: 10
transformations:
  - id: field_mapping_windows
    type: field_name_mapping
    mapping:
        Provider_Name: "Provider.#attributes.EventSourceName"
    rule_conditions:
      - type: logsource
        product: windows

  - id: condition_system_channel
    type: add_condition
    conditions:
      Channel: System
    rule_conditions:
      - type: logsource
        product: windows
        service: system

  - id: condition_security_channel
    type: add_condition
    conditions:
      Channel: Security
    rule_conditions:
      - type: logsource
        product: windows
        service: security

  - id: condition_psclassic
    type: add_condition
    conditions:
      Channel: "Windows PowerShell"
    rule_conditions:
      - type: logsource
        product: windows
        category: ps_classic_provider_start

  - id: condition_psclassic2
    type: add_condition
    conditions:
      Channel: "Windows PowerShell"
    rule_conditions:
      - type: logsource
        product: windows
        category: ps_classic_start

  - id: condition_psclassic3
    type: add_condition
    conditions:
      Channel: "Windows PowerShell"
    rule_conditions:
      - type: logsource
        product: windows
        service: powershell-classic

  - id: condition_ps_module
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 4103
    rule_conditions:
      - type: logsource
        product: windows
        category: ps_module 

  - id: condition_ps_sbl
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 4104
    rule_conditions:
      - type: logsource
        product: windows
        category: ps_script 

  - id: condition_sysmon_channel
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-Sysmon/Operational"
    rule_conditions:
      - type: logsource
        product: windows
        service: sysmon

  - id: condition_windows_process_creation
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 1
    rule_conditions:
      - type: logsource
        product: windows
        category: process_creation

  - id: condition_windows_create_remote_thread
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 8
    rule_conditions:
      - type: logsource
        product: windows
        category: create_remote_thread

  - id: condition_windows_create_stream_hash
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 15
    rule_conditions:
      - type: logsource
        product: windows
        category: create_stream_hash

  - id: condition_windows_dns_query
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 22
    rule_conditions:
      - type: logsource
        product: windows
        category: dns_query

  - id: condition_windows_driver_load
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 6
    rule_conditions:
      - type: logsource
        product: windows
        category: driver_load

  - id: condition_windows_file_event
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 11
    rule_conditions:
      - type: logsource
        product: windows
        category: file_event

  - id: condition_windows_file_delete
    type: add_condition
    conditions:
      Channel: "Microsoft-Windows-PowerShell/Operational"
      EventID: 
        - 23
        - 26
    rule_conditions:
      - type: logsource
        product: windows
        category: file_delete

name: Splunk Alert stanza Windows
priority: 20
postprocessing:
- type: template
  template: |+
    [{{ rule.title }}]
    description = {{ rule.description }}
    search = index=evtx _index_earliest=-1h@h | rename Event.EventData.* as *  Event.System.* as * | search {{ query }} | fields - _raw | collect index=notable_events source="{{ rule.title }}" marker="guid={{ rule.id }}"
  rule_conditions:
    - type: logsource
      product: windows

finalizers:
- type: template
  template: |
    [default]
    cron_schedule = */30 * * * *
    dispatch.earliest_time = 0
    dispatch.latest_time = now
    enableSched = 0
    schedule_window = auto
    {{ queries | join('\n') }}
